{
  "name": "create-profile",
  "method": "POST",
  "description": "Create a new Ayrshare profile for a user and store the profile key",
  "inputs": [
    {
      "name": "userId",
      "type": "string",
      "required": true,
      "description": "Unique identifier for the user"
    },
    {
      "name": "title",
      "type": "string",
      "required": false,
      "description": "Optional title for the profile"
    }
  ],
  "function_stack": [
    {
      "type": "function",
      "name": "Check if profile exists",
      "code": "// Check if user already has a profile\nconst existingProfile = await xano.db.social_profiles.getFirst({\n  user_id: inputs.userId\n});\n\nif (existingProfile) {\n  return {\n    success: false,\n    error: 'User already has a social profile',\n    profileKey: existingProfile.profile_key\n  };\n}"
    },
    {
      "type": "external_api",
      "name": "Create Ayrshare Profile",
      "method": "POST",
      "url": "https://app.ayrshare.com/api/profiles/create-profile",
      "headers": {
        "Authorization": "Bearer {{env.AYRSHARE_API_KEY}}",
        "Content-Type": "application/json"
      },
      "body": {
        "userId": "{{inputs.userId}}",
        "title": "{{inputs.title || 'Barkhaus User Profile'}}"
      },
      "response_variable": "ayrshare_response"
    },
    {
      "type": "function",
      "name": "Handle Ayrshare Response",
      "code": "// Check if Ayrshare request was successful\nif (!ayrshare_response || ayrshare_response.status !== 'success') {\n  return {\n    success: false,\n    error: ayrshare_response?.error || 'Failed to create Ayrshare profile',\n    details: ayrshare_response\n  };\n}\n\nconst profileKey = ayrshare_response.profileKey;\nif (!profileKey) {\n  return {\n    success: false,\n    error: 'No profile key returned from Ayrshare'\n  };\n}"
    },
    {
      "type": "database",
      "name": "Store Profile in Database",
      "operation": "create",
      "table": "social_profiles",
      "data": {
        "user_id": "{{inputs.userId}}",
        "profile_key": "{{profileKey}}",
        "title": "{{inputs.title || 'Barkhaus User Profile'}}",
        "connected_networks": "[]",
        "created_at": "{{new Date().toISOString()}}",
        "updated_at": "{{new Date().toISOString()}}"
      },
      "response_variable": "db_profile"
    },
    {
      "type": "function",
      "name": "Return Success Response",
      "code": "return {\n  success: true,\n  profileKey: profileKey,\n  userId: inputs.userId,\n  title: inputs.title || 'Barkhaus User Profile',\n  profile: db_profile\n};"
    }
  ],
  "error_handling": {
    "catch_all": {
      "type": "function",
      "code": "console.error('Error in create-profile:', error);\nreturn {\n  success: false,\n  error: error.message || 'Internal server error',\n  details: error\n};"
    }
  }
}
