---
import BaseLayout from "@layouts/BaseLayout.astro";
import CTA from "@components/CTA.astro";

const SITE_NAME = "Happy Paws Dog Rescue";

interface Animal {
  id: string | number;
  name: string;
  breed: string;
  age: string;
  gender: string;
  size: string;
  weight?: string;
  status?: string;
  description?: string;
  description_long?: string;
  image_url?: string;
  images?: string[];
  main_image?: { url: string };
  additional_image_1?: { url: string };
  additional_image_2?: { url: string };
  additional_image_3?: { url: string };
  additional_image_4?: { url: string };
  spayed_neutered?: boolean;
  vaccinated?: boolean;
  microchip?: boolean;
  special_needs?: boolean;
  medical_notes?: string;
  good_with_kids?: boolean;
  good_with_cats?: boolean;
  good_with_dogs?: boolean;
  energy_level?: string;
  house_trained?: boolean;
}

export async function getStaticPaths() {
  const fallbackIds = ['luna', 'max'];

  try {
    const response = await fetch(`http://localhost:4321/api/admin/animals?orgId=3`);
    if (response.ok) {
      const animals = await response.json();
      return animals.map((animal: Animal) => ({
        params: { id: animal.id.toString() }
      }));
    }
  } catch (error) {
    console.error('Error fetching animals for static paths, using fallback:', error);
  }

  return fallbackIds.map(id => ({
    params: { id: id.toString() }
  }));
}

const { id } = Astro.params;

let animal: Animal | null = null;
try {
  const response = await fetch(`${Astro.url.origin}/api/admin/animals?orgId=3`);
  if (response.ok) {
    const animals = await response.json();
    animal = animals.find((a: Animal) => a.id.toString() === id);
  }
} catch (error) {
  console.error('Error fetching animal details:', error);
}

const fallbackAnimals: Record<string, Animal> = {
  "luna": {
    id: "luna",
    name: "Luna",
    breed: "Golden Retriever Mix",
    age: "3 years",
    gender: "Female",
    size: "Large",
    status: "Available",
    description: "Luna is a sweet and gentle girl who loves playing fetch and cuddling on the couch. She's been with us for a few months and has shown incredible resilience and love despite her difficult past.",
    image_url: "/assets/images/animals/luna-1.jpg",
    spayed_neutered: true,
    vaccinated: true,
    microchip: true,
    special_needs: false,
    medical_notes: "Healthy and ready for adoption",
    good_with_kids: true,
    good_with_cats: true,
    good_with_dogs: true,
    energy_level: "Medium",
    house_trained: true
  },
  "max": {
    id: "max",
    name: "Max",
    breed: "Domestic Shorthair",
    age: "2 years",
    gender: "Male",
    size: "Medium",
    status: "Available",
    description: "Max is a playful tabby who loves toys and sunny windowsills. He's a curious cat who enjoys exploring and would do well in a home with plenty of enrichment.",
    image_url: "/assets/images/animals/max-1.jpg",
    spayed_neutered: true,
    vaccinated: true,
    microchip: true,
    special_needs: false,
    medical_notes: "Healthy young cat",
    good_with_kids: true,
    good_with_cats: true,
    good_with_dogs: false,
    energy_level: "High",
    house_trained: true
  }
};

if (!animal) {
  animal = fallbackAnimals[id];
}

if (!animal) {
  return Astro.redirect('/404');
}

const safeAnimal = animal as Animal;
const galleryImages = safeAnimal.images && safeAnimal.images.length > 0
  ? safeAnimal.images
  : [
      safeAnimal.image_url,
      safeAnimal.additional_image_1?.url,
      safeAnimal.additional_image_2?.url,
      safeAnimal.additional_image_3?.url,
      safeAnimal.additional_image_4?.url,
    ].filter(Boolean) as string[];
---

<BaseLayout
  title={`${SITE_NAME} - Meet ${safeAnimal.name}`}
  description={`Learn more about ${safeAnimal.name}, a ${safeAnimal.age} ${safeAnimal.breed} looking for a loving home. ${safeAnimal.description}`}
>
  <!-- ============================================ -->
  <!--              Animal Details Header           -->
  <!-- ============================================ -->
  
  <section id="animal-header">
    <div class="cs-container">
      <div class="cs-content">
        <div class="cs-image-gallery">
          <div class="cs-main-image">
            <img
              src={safeAnimal.image_url || galleryImages[0] || '/assets/images/animals/placeholder.jpg'}
              alt={safeAnimal.name}
              width="600"
              height="400"
              loading="eager"
            />
          </div>
          {galleryImages.length > 1 && (
            <div class="cs-thumbnail-gallery">
              {galleryImages.map((image, index) => (
                <img
                  src={image}
                  alt={`${safeAnimal.name} photo ${index + 1}`}
                  width="100"
                  height="100"
                  class={index === 0 ? "active" : ""}
                  data-main-src={image}
                />
              ))}
            </div>
          )}
        </div>
        
        <div class="cs-info">
          <div class={`cs-status-badge cs-status-${(safeAnimal.status || 'available').toLowerCase()}`}>
            {safeAnimal.status || 'Available'}
          </div>
          <h1 class="cs-title">{safeAnimal.name}</h1>
          <div class="cs-basic-info">
            {safeAnimal.breed && (
              <div class="cs-info-item">
                <strong>Breed:</strong> {safeAnimal.breed}
              </div>
            )}
            {safeAnimal.age && (
              <div class="cs-info-item">
                <strong>Age:</strong> {safeAnimal.age}
              </div>
            )}
            {safeAnimal.gender && (
              <div class="cs-info-item">
                <strong>Gender:</strong> {safeAnimal.gender}
              </div>
            )}
            {safeAnimal.size && (
              <div class="cs-info-item">
                <strong>Size:</strong> {safeAnimal.size}
              </div>
            )}
            {safeAnimal.weight && (
              <div class="cs-info-item">
                <strong>Weight:</strong> {safeAnimal.weight}
              </div>
            )}
          </div>
          
          {safeAnimal.description && <p class="cs-description">{safeAnimal.description}</p>}
          
          <div class="cs-action-buttons">
            <a href="/applications" class="cs-button-solid">Apply to Adopt {safeAnimal.name}</a>
            <a href="/contact" class="cs-button-transparent">Ask About {safeAnimal.name}</a>
          </div>
        </div>
      </div>

      <div class="cs-animal-details-grid">
        <div class="cs-animal-details">
          <h2>About {safeAnimal.name}</h2>
          <div class="cs-detail-grid">
            <div class="cs-detail-item">
              <span class="cs-detail-label">Energy Level</span>
              <span class="cs-detail-value">{safeAnimal.energy_level || 'Moderate'}</span>
            </div>
            <div class="cs-detail-item">
              <span class="cs-detail-label">House Trained</span>
              <span class="cs-detail-value">{safeAnimal.house_trained ? 'Yes' : 'In Progress'}</span>
            </div>
            <div class="cs-detail-item">
              <span class="cs-detail-label">Good with Kids</span>
              <span class="cs-detail-value">{safeAnimal.good_with_kids ? 'Yes' : 'Not Yet Tested'}</span>
            </div>
            <div class="cs-detail-item">
              <span class="cs-detail-label">Good with Dogs</span>
              <span class="cs-detail-value">{safeAnimal.good_with_dogs ? 'Yes' : 'Not Yet Tested'}</span>
            </div>
            <div class="cs-detail-item">
              <span class="cs-detail-label">Good with Cats</span>
              <span class="cs-detail-value">{safeAnimal.good_with_cats ? 'Yes' : 'Not Yet Tested'}</span>
            </div>
            <div class="cs-detail-item">
              <span class="cs-detail-label">Special Needs</span>
              <span class="cs-detail-value">{safeAnimal.special_needs ? 'Yes' : 'No'}</span>
            </div>
          </div>
        </div>
